<!DOCTYPE html>
<html lang="ko" data-theme="auto">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Markdown + LaTeX Live Preview</title>
    <style>
      :root {
        --bg: #0b1020;
        --panel: #0f1530;
        --ink: #e6e9f5;
        --muted: #a2add6;
        --accent: #7aa2f7;
        --border: #1c244a;
        --ok: #89d185;
        --code: #0b122a;
        --shadow: 0 12px 40px rgba(0, 0, 0, 0.28);
        --radius: 16px;
        --focus: 0 0 0 3px rgba(122, 162, 247, 0.35);
        --transition: 160ms ease;
      }
      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f7f8fb;
          --panel: #ffffff;
          --ink: #0f1527;
          --muted: #53607a;
          --accent: #2f6feb;
          --border: #e6e9f2;
          --ok: #2e8f54;
          --code: #f3f5fa;
          --shadow: 0 12px 40px rgba(39, 59, 98, 0.1);
        }
      }
      /* Force dark */
      html[data-theme="dark"] {
        --bg: #0b1020;
        --panel: #0f1530;
        --ink: #e6e9f5;
        --muted: #a2add6;
        --accent: #7aa2f7;
        --border: #1c244a;
        --ok: #89d185;
        --code: #0b122a;
        --shadow: 0 12px 40px rgba(0, 0, 0, 0.28);
      }
      /* Force light */
      html[data-theme="light"] {
        --bg: #f7f8fb;
        --panel: #ffffff;
        --ink: #0f1527;
        --muted: #53607a;
        --accent: #2f6feb;
        --border: #e6e9f2;
        --ok: #2e8f54;
        --code: #f3f5fa;
        --shadow: 0 12px 40px rgba(39, 59, 98, 0.1);
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--ink);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      }
      body {
        transition: background-color var(--transition), color var(--transition);
      }
      .wrap {
        display: grid;
        grid-template-rows: auto 1fr auto;
        height: 100%;
      }

      header.appbar {
        padding: 14px 18px;
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.03), rgba(0, 0, 0, 0));
        position: sticky;
        top: 0;
        z-index: 3;
        backdrop-filter: blur(6px);
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .logo {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: grid;
        place-items: center;
        background: var(--accent);
        color: white;
        font-weight: 800;
        box-shadow: var(--shadow);
      }
      header.appbar h1 {
        font-size: 16px;
        font-weight: 700;
        margin: 0;
        letter-spacing: 0.2px;
      }
      header.appbar .hint {
        color: var(--muted);
        font-size: 12px;
      }

      .controls {
        display: inline-flex;
        align-items: center;
        gap: 12px;
      }
      .select {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--panel);
        box-shadow: var(--shadow);
      }
      select {
        appearance: none;
        border: none;
        background: transparent;
        color: var(--ink);
        font-weight: 600;
        padding-right: 18px;
        cursor: pointer;
        outline: none;
      }
      select:focus {
        box-shadow: var(--focus);
        border-radius: 8px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        padding: 12px;
        height: 100%;
        overflow: hidden;
      }
      .panel {
        display: flex;
        flex-direction: column;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        min-height: 0;
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: background-color var(--transition), border-color var(--transition);
      }
      .panel header {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        background: transparent;
      }
      .panel header h2 {
        font-size: 12px;
        letter-spacing: 0.3px;
        margin: 0;
        color: var(--muted);
        text-transform: uppercase;
      }

      .editor {
        flex: 1;
        min-height: 0;
        overflow: hidden;
        padding: 14px;
      }
      .preview {
        flex: 1;
        min-height: 0;
        overflow: auto;
        padding: 14px;
      }
      textarea {
        width: 100%;
        height: 100%;
        resize: none;
        background: transparent;
        color: var(--ink);
        border: none;
        outline: none;
        font-size: 14px;
        line-height: 1.6;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      }
      .preview {
        font-size: 15px;
        line-height: 1.7;
      }
      .preview h1,
      .preview h2,
      .preview h3 {
        color: var(--ink);
      }
      .preview a {
        color: var(--accent);
        text-decoration: none;
      }
      .preview a:hover {
        text-decoration: underline;
      }
      .preview code,
      .preview pre {
        background: var(--code);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 2px 6px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      }
      .preview pre {
        padding: 12px;
        overflow: auto;
      }

      .preview blockquote {
        margin: 0;
        padding: 10px 14px;
        border-left: 4px solid var(--accent);
        background: color-mix(in srgb, var(--accent) 10%, transparent);
        color: color-mix(in srgb, var(--ink) 85%, var(--muted));
        border-radius: 10px;
      }
      .preview table {
        border-collapse: collapse;
        width: 100%;
        font-size: 14px;
      }
      .preview th,
      .preview td {
        border: 1px solid var(--border);
        padding: 8px 10px;
        text-align: left;
      }
      .preview th {
        background: color-mix(in srgb, var(--accent) 8%, var(--panel));
      }

      footer {
        border-top: 1px solid var(--border);
        display: grid;
        grid-template-columns: 1fr auto auto;
        align-items: center;
        padding: 10px 14px;
        gap: 12px;
        color: var(--muted);
        font-size: 13px;
        background: linear-gradient(0deg, rgba(0, 0, 0, 0.03), rgba(0, 0, 0, 0));
        position: sticky;
        bottom: 0;
      }
      .stat {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .badge {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--panel);
        border: 1px solid var(--border);
        color: var(--ink);
        font-weight: 700;
      }
      .btn {
        appearance: none;
        border: 1px solid var(--border);
        background: var(--panel);
        color: var(--ink);
        padding: 9px 12px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        transition: transform var(--transition);
        box-shadow: var(--shadow);
      }
      .btn:hover {
        transform: translateY(-1px);
      }
      .ok {
        color: var(--ok);
      }

      .kbd {
        font: 600 12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        background: var(--code);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 2px 6px;
      }

      @media (max-width: 1000px) {
        .grid {
          grid-template-columns: 1fr;
          grid-template-rows: 1fr 1fr;
        }
      }
    </style>

    <!-- Marked -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- MathJax v3 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            ["$", "$"],
            ["\\(", "\\)"],
          ],
          displayMath: [
            ["$$", "$$"],
            ["\\[", "\\]"],
          ],
          processEscapes: true,
        },
        svg: { fontCache: "global" },
        options: { skipHtmlTags: ["script", "noscript", "style", "textarea", "pre", "code"] },
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  </head>
  <body>
    <div class="wrap">
      <header class="appbar">
        <div class="brand">
          <div class="logo" aria-hidden="true">M</div>
          <div>
            <h1>Markdown + LaTeX Live Preview</h1>
            <div class="hint">좌측 입력 • 우측 미리보기 • 수식 지원</div>
          </div>
        </div>
        <div class="controls">
          <div class="select" title="테마 설정">
            <label for="theme" class="hint">Theme</label>
            <select id="theme" aria-label="Theme">
              <option value="auto">Auto (System)</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>
        </div>
      </header>

      <div class="grid">
        <section class="panel">
          <header><h2>Editor</h2></header>
          <div class="editor">
            <textarea
              id="input"
              spellcheck="false"
              placeholder="# Hello, Markdown!\n\n- Inline math: $E=mc^2$\n- Display math:\n\n$$\n\\int_a^b f(x)\\,dx = F(b)-F(a)\n$$\n\n**Tip:** 코드 블록, 표, 인용구도 지원합니다."
            ></textarea>
          </div>
        </section>

        <section class="panel">
          <header><h2>Preview</h2></header>
          <div id="preview" class="preview" aria-live="polite"></div>
        </section>
      </div>

      <footer>
        <div class="stat">Characters (incl. spaces): <span id="charCount" class="badge">0</span></div>
        <div class="stat">Render status: <span id="status" class="badge">Idle</span></div>
        <div class="stat">
          <button id="downloadBtn" class="btn" title="현재 입력을 .md로 저장 (Ctrl/Cmd+S)">Download .md</button>
          <button id="copyBtn" class="btn" title="입력 내용 복사 (Ctrl/Cmd+C)">Copy</button>
        </div>
      </footer>
    </div>

    <script>
      // Theme logic
      const themeSelect = document.getElementById("theme");
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)");
      const KEY = "mdlatex.theme";

      function applyTheme(mode) {
        document.documentElement.setAttribute("data-theme", mode);
      }
      function loadTheme() {
        const saved = localStorage.getItem(KEY) || "auto";
        themeSelect.value = saved;
        applyTheme(saved);
      }
      themeSelect.addEventListener("change", () => {
        const val = themeSelect.value;
        localStorage.setItem(KEY, val);
        applyTheme(val);
      });
      prefersDark.addEventListener("change", () => {
        // Only react if user set Auto
        if ((localStorage.getItem(KEY) || "auto") === "auto") applyTheme("auto");
      });
      loadTheme();

      // Configure Marked
      marked.setOptions({ gfm: true, breaks: true, mangle: false, headerIds: true });

      const inputEl = document.getElementById("input");
      const previewEl = document.getElementById("preview");
      const charCountEl = document.getElementById("charCount");
      const statusEl = document.getElementById("status");
      const downloadBtn = document.getElementById("downloadBtn");
      const copyBtn = document.getElementById("copyBtn");

      // Debounce helper
      function debounce(fn, delay = 120) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), delay);
        };
      }

      function updateCharCount() {
        charCountEl.textContent = inputEl.value.length.toLocaleString();
      }

      async function render() {
        statusEl.textContent = "Rendering…";
        const rawHtml = marked.parse(inputEl.value);
        const safeHtml = DOMPurify.sanitize(rawHtml, { USE_PROFILES: { html: true } });
        previewEl.innerHTML = safeHtml;
        try {
          if (window.MathJax && window.MathJax.typesetPromise) {
            await MathJax.typesetPromise([previewEl]);
          }
          statusEl.textContent = "OK";
          statusEl.classList.add("ok");
        } catch (e) {
          statusEl.textContent = "MathJax error";
          statusEl.classList.remove("ok");
        }
      }
      const update = debounce(() => {
        updateCharCount();
        render();
      }, 100);
      inputEl.addEventListener("input", update);
      update(); // initial

      // Download as .md
      function downloadMD() {
        const blob = new Blob([inputEl.value], { type: "text/markdown;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "note.md";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      downloadBtn.addEventListener("click", downloadMD);

      // Keyboard: Ctrl/Cmd+S to save .md
      //window.addEventListener("keydown", (e) => {
      //  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
      //    e.preventDefault();
      //    downloadMD();
      //  }
      //});

      // Copy to clipboard
      copyBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(inputEl.value);
          copyBtn.textContent = "Copied!";
          setTimeout(() => (copyBtn.textContent = "Copy"), 1200);
        } catch (e) {
          copyBtn.textContent = "Unable to copy";
          setTimeout(() => (copyBtn.textContent = "Copy"), 1200);
        }
      });
    </script>
  </body>
</html>
