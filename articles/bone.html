<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ushin20 - post</title>
    <link rel="stylesheet" href="/css/common.css" />
    <link rel="stylesheet" href="/articles/bone.css" />
    <script src="/js/meta.js" defer></script>

    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            ["$", "$"],
            ["\\(", "\\)"],
          ],
          displayMath: [
            ["$$", "$$"],
            ["\\[", "\\]"],
          ],
          processEnvironments: true,
          packages: ["base", "ams"],
        },
        svg: {
          fontCache: "global", // 성능/일관성 좋음 ("local"/"none"도 가능)
          mtextInheritFont: false, // 수식 텍스트를 시스템 폰트가 아닌 TeX 폰트로
          scale: 1, // 필요시 0.95~1.1로 조절
        },
      };
    </script>

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  </head>

  <body>
    <main>
      <div class="frame">
        <div id="post-info"></div>
        <div id="content"></div>
      </div>
    </main>
    <!-- jQuery 라이브러리 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Marked 라이브러리 (Markdown -> HTML 변환) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const mdFile = urlParams.get("md");

        const renderTables = () => {
          document.querySelectorAll("#content table").forEach((table) => {
            const wrapper = document.createElement("div");
            wrapper.classList.add("table-container");
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
          });
        };

        const typesetContent = async () => {
          // MathJax가 로드/초기화될 때까지 대기
          if (window.MathJax?.startup?.promise) {
            await window.MathJax.startup.promise;
          }
          if (window.MathJax?.typesetPromise) {
            // #content 영역만 타입셋
            await window.MathJax.typesetPromise([document.getElementById("content")]);
          } else {
            console.warn("MathJax is not ready yet.");
          }
        };

        if (mdFile) {
          fetch(`/articles/mds/${mdFile}`)
            .then((res) => {
              if (!res.ok) throw new Error(`Cannot fetch file: ${mdFile}. Status: ${res.status}`);
              return res.text();
            })
            .then(async (data) => {
              let markdownContent = data;
              const parts = data.split(/---[\r\n]+/);
              if (parts.length >= 3) {
                const metaContent = parts[1].trim();
                markdownContent = parts.slice(2).join("---").trim();

                // 메타 렌더링
                const metaLines = metaContent.split("\n");
                let metaHtml = "";
                metaLines.forEach((line) => {
                  const key = line.split(":")[0].trim().toLowerCase();
                  const value = line
                    .substring(line.indexOf(":") + 1)
                    .trim()
                    .replace(/^"|"$/g, "");
                  if (key === "title") metaHtml += `<h1>${value}</h1>`;
                  else if (key === "author") metaHtml += `<p>${value}</p>`;
                  else if (key === "published") metaHtml += `<p>${key} in ${value}</p>`;
                  else if (key === "date") metaHtml += `<p><i class="fa-solid fa-calendar-days"></i> ${value}</p>`;
                });
                document.getElementById("post-info").innerHTML = metaHtml;
              }

              // 본문 마크다운 → HTML
              document.getElementById("content").innerHTML =
                marked.parse(markdownContent) +
                `
              <div class="post-footer">
                <div style="text-align: center; margin-top: 10px;">
                  <a href="javascript:history.back()" class="back-button">뒤로가기</a>
                </div>
              </div>
            `;

              renderTables();
              await typesetContent();
            })
            .catch((err) => {
              console.error("Error loading markdown:", err);
              document.getElementById("content").innerHTML = `
            <div id='Error404'>
              <p>404: The requested page was not found.</p>
              <a href='javascript:history.back()'>뒤로가기</a>
            </div>`;
            });
        } else {
          console.error("No md file specified in the URL.");
          document.getElementById("content").innerText = "No project selected. Please provide an md file in the URL parameters.";
        }
      });
    </script>
  </body>
</html>
